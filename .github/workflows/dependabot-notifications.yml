name: Dependabot Notifications

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.actor.login == 'dependabot[bot]' &&
      github.event.workflow_run.event == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get PR details
        id: pr
        run: |
          PR_NUMBER=$(gh pr list --head "$HEAD_BRANCH" --json number,title,url --jq '.[0]')
          echo "details=$PR_NUMBER" >> $GITHUB_OUTPUT
          PR_URL=$(echo "$PR_NUMBER" | jq -r '.url')
          PR_TITLE=$(echo "$PR_NUMBER" | jq -r '.title')
          echo "url=$PR_URL" >> $GITHUB_OUTPUT
          echo "title=$PR_TITLE" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}

      - name: Send success notification to Slack
        if: env.SLACK_WEBHOOK != ''
        run: |
          curl -X POST "$SLACK_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d '{
              "attachments": [
                {
                  "color": "#36a64f",
                  "title": "âœ… Dependabot PR Ready to Merge",
                  "title_link": "${{ steps.pr.outputs.url }}",
                  "text": "${{ steps.pr.outputs.title }}",
                  "fields": [
                    {
                      "title": "Repository",
                      "value": "${{ github.repository }}",
                      "short": true
                    },
                    {
                      "title": "Branch",
                      "value": "${{ github.event.workflow_run.head_branch }}",
                      "short": true
                    }
                  ],
                  "footer": "logzio-go CI",
                  "ts": ${{ github.event.workflow_run.run_started_at && '0' || '0' }}
                }
              ]
            }'
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.actor.login == 'dependabot[bot]' &&
      github.event.workflow_run.event == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get PR details
        id: pr
        run: |
          PR_NUMBER=$(gh pr list --head "$HEAD_BRANCH" --json number,title,url --jq '.[0]')
          echo "details=$PR_NUMBER" >> $GITHUB_OUTPUT
          PR_URL=$(echo "$PR_NUMBER" | jq -r '.url')
          PR_TITLE=$(echo "$PR_NUMBER" | jq -r '.title')
          echo "url=$PR_URL" >> $GITHUB_OUTPUT
          echo "title=$PR_TITLE" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}

      - name: Send failure notification to Slack
        if: env.SLACK_WEBHOOK != ''
        run: |
          curl -X POST "$SLACK_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d '{
              "attachments": [
                {
                  "color": "#dc3545",
                  "title": "ðŸš¨ Dependabot PR CI Failed - Needs Review",
                  "title_link": "${{ github.event.workflow_run.html_url }}",
                  "text": "${{ steps.pr.outputs.title }}",
                  "fields": [
                    {
                      "title": "Repository",
                      "value": "${{ github.repository }}",
                      "short": true
                    },
                    {
                      "title": "Branch",
                      "value": "${{ github.event.workflow_run.head_branch }}",
                      "short": true
                    },
                    {
                      "title": "PR Link",
                      "value": "${{ steps.pr.outputs.url }}",
                      "short": false
                    }
                  ],
                  "footer": "logzio-go CI",
                  "ts": ${{ github.event.workflow_run.run_started_at && '0' || '0' }}
                }
              ]
            }'
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

